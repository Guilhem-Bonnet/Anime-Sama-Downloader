services:
  backend:
    image: golang:1.22-alpine
    container_name: asd-backend
    working_dir: /app
    command: sh -lc "go run ./cmd/asd-server -addr 0.0.0.0:8080 -db /data/asd.db"
    ports:
      - "8080:8080"
    environment:
      ASD_ADDR: 0.0.0.0:8080
      ASD_DB_PATH: /data/asd.db
      # Optionnel: si vous avez une SPA build (sinon utilisez le service frontend Vite)
      ASD_WEB_DIST: /app/webapp/dist
    volumes:
      - .:/app
      - ${ASD_HOST_DOWNLOAD_ROOT:-./videos}:/data/videos
      - ${ASD_HOST_DATA_ROOT:-./data}:/data

  frontend:
    image: node:20-alpine
    container_name: asd-frontend
    working_dir: /webapp
    command: sh -lc "npm ci && npm run dev -- --host 0.0.0.0 --port 5173"
    ports:
      - "5173:5173"
    environment:
      # Important: en Docker, le backend n'est pas sur 127.0.0.1
      VITE_PROXY_TARGET: http://backend:8080
    volumes:
      - ./webapp:/webapp
      - asd_webapp_node_modules:/webapp/node_modules
    depends_on:
      - backend

  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    profiles: ["media"]
    ports:
      - "8096:8096"
    volumes:
      - ./jellyfin-config:/config
      - ./jellyfin-cache:/cache
      # Même dossier que le downloader (sur l'hôte) mais monté en lecture côté Jellyfin
      - ${ASD_HOST_DOWNLOAD_ROOT:-./videos}:/media:ro

volumes:
  asd_webapp_node_modules:
